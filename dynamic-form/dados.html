<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dados Enviados</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="text-center mb-4">Dados Enviados</h1>

        <!-- Mensagem de Feedback -->
        <div id="feedback" class="mb-4"></div>

        <!-- Tabela de Dados -->
        <div class="card shadow">
            <div class="card-header">
                <h4>Dados Coletados</h4>
                <button id="export-csv" class="btn btn-success float-end">Exportar para CSV</button>
            </div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead id="table-head">
                        <!-- Cabeçalho da tabela será gerado dinamicamente -->
                    </thead>
                    <tbody id="table-body">
                        <!-- Dados serão adicionados dinamicamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const apiUrl = "http://127.0.0.1:5000/api";

        // Função para buscar dados salvos do backend
        async function fetchData() {
            try {
                const response = await fetch(`${apiUrl}/data`);
                if (!response.ok) {
                    throw new Error("Erro ao buscar os dados.");
                }
                const data = await response.json();
                if (data.length === 0) {
                    document.getElementById("feedback").className = "alert alert-info";
                    document.getElementById("feedback").textContent = "Nenhum dado encontrado.";
                } else {
                    generateTable(data);
                }
            } catch (error) {
                const feedback = document.getElementById("feedback");
                feedback.className = "alert alert-danger";
                feedback.textContent = `Erro ao carregar dados: ${error.message}`;
            }
        }

        // Função para gerar a tabela dinamicamente
        function generateTable(data) {
            const tableHead = document.getElementById("table-head");
            const tableBody = document.getElementById("table-body");

            // Limpar conteúdo anterior
            tableHead.innerHTML = "";
            tableBody.innerHTML = "";

            // Criar cabeçalho
            const headers = Object.keys(data[0]);
            const headerRow = document.createElement("tr");
            headers.forEach(header => {
                const th = document.createElement("th");
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Criar linhas de dados
            data.forEach(row => {
                const tr = document.createElement("tr");
                headers.forEach(header => {
                    const td = document.createElement("td");
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // Função para exportar os dados para CSV
        async function exportToCSV() {
            try {
                const response = await fetch(`${apiUrl}/data`);
                if (!response.ok) {
                    throw new Error("Erro ao buscar os dados para exportação.");
                }
                const data = await response.json();
                if (data.length === 0) {
                    alert("Nenhum dado disponível para exportação.");
                    return;
                }

                // Gerar o conteúdo do CSV
                const headers = Object.keys(data[0]).join(",");
                const rows = data.map(row => Object.values(row).join(",")).join("\n");
                const csvContent = `${headers}\n${rows}`;

                // Criar e baixar o arquivo CSV
                const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = "dados.csv";
                link.style.display = "none";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                alert(`Erro ao exportar dados: ${error.message}`);
            }
        }

        // Carregar os dados ao carregar a página
        document.addEventListener("DOMContentLoaded", fetchData);

        // Evento para o botão de exportação
        document.getElementById("export-csv").addEventListener("click", exportToCSV);
    </script>
</body>
</html>
